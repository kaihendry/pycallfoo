name: Call foo

on:
  push:
  workflow_dispatch:
    inputs:
      pyunderstand_ref:
        description: 'Git ref for kaihendry/pyunderstand (branch, tag, or SHA)'
        required: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Determine pyunderstand ref
      id: ref
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        REF="${{ inputs.pyunderstand_ref }}"
        if [[ -z "$REF" ]]; then
          BRANCH="${GITHUB_REF#refs/heads/}"
          if gh api "repos/kaihendry/pyunderstand/branches/$BRANCH" --silent 2>/dev/null; then
            REF="$BRANCH"
          fi
        fi
        if [[ -z "$REF" && -f config.yaml ]]; then
          REF=$(yq '.version' config.yaml)
        fi
        echo "ref=$REF" >> "$GITHUB_OUTPUT"
    - uses: actions/checkout@v6
      with:
        repository: kaihendry/pyunderstand
        ref: ${{ steps.ref.outputs.ref }}
        path: pyunderstand
    - uses: astral-sh/setup-uv@v7
    - run: uv add --editable ./pyunderstand
    - run: uv sync
    - run: uv run main.py
